```{r}
#| label: setup
#| include: false

library(tidyverse)
```

# Rule of selection

* BMI < 22
* No outliers

```{r}
targets::tar_load(c(users, indices, data_parsed_PIQ))
users_bmi_check <- data_parsed_PIQ |>
  mutate(
    map(
      c(height = 3, weight = 4),
      ~ map2_chr(raw_parsed, .,  ~ .x$resp[[.y]]) |>
        as.numeric()
    ) |>
      as_tibble(),
    bmi = weight / (height / 100) ^ 2,
    .keep = "unused"
  ) |>
  filter(bmi < 22)
indices_check <- indices |>
  filter(!any(str_detect(project_name, "å¼ƒ")), .by = user_id) |>
  semi_join(
    read_csv("config/game_indices.csv", show_col_types = F) |>
      filter(selected),
    by = join_by(game_name, index_name)
  ) |>
  mutate(
    is_outlier = performance::check_outliers(score, method = "iqr") |> unclass(),
    .by = c(game_name, index_name)
  ) |>
  filter(!any(is_outlier), .by = user_id)
users |>
  semi_join(users_bmi_check, by = "user_id") |>
  semi_join(indices_check, by = "user_id") |>
  select(user_name, user_phone) |>
  writexl::write_xlsx("output/fmri_users_sel.xlsx")
```
