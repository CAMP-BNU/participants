---
title: "Screen fmri users for TJNU"
---

```{r}
#| label: setup
#| include: false

library(tidyverse)
requireNamespace("bit64")
source("../R/utils-data.R")
```

# Rule of selection

* BMI < 22
* No outliers

```{r}
targets::tar_load(c(users, data_parsed, data_parsed_PIQ, progress))
users_bmi_check <- data_parsed_PIQ |>
  mutate(
    map(
      c(height = 3, weight = 4),
      ~ map2_chr(raw_parsed, .,  ~ .x$resp[[.y]]) |>
        as.numeric()
    ) |>
      as_tibble(),
    bmi = weight / (height / 100) ^ 2,
    .keep = "unused"
  ) |>
  filter(bmi < 22)
config <- read_csv("../config/fmri-screen.csv", show_col_types = F)
check_result_raw <- data_parsed |> 
  left_join(config, by = "game_name") |> 
  filter(!is.na(method)) |> 
  mutate(
    passed = pmap_dbl(
      list(data = raw_parsed, game_name, method, chance),
      check_raw
    )
  )
raw_data_check <- check_result_raw |> 
  summarise(n_fail = sum(!passed), .by = user_id) |> 
  filter(n_fail <= 2)
progress_check <- progress |> 
  summarise(n = sum(progress) / 100, .by = user_id) |> 
  filter(n > 1)
users |>
  # semi_join(progress_check, by = "user_id") |>
  semi_join(users_bmi_check, by = "user_id") |>
  semi_join(raw_data_check, by = "user_id") |>
  select(user_name, user_phone) |>
  writexl::write_xlsx("output/fmri_users_sel.xlsx")
```
